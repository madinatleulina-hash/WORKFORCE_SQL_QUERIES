WITH History_Sorted AS (
    SELECT 
        EMAIL, VALID_FROM, JOB_TITLE, SALARY_PAY_TYPE, EMPLOYMENT_TYPE,
        LAG(JOB_TITLE) OVER (PARTITION BY EMAIL ORDER BY VALID_FROM) as prev_job,
        LAG(SALARY_PAY_TYPE) OVER (PARTITION BY EMAIL ORDER BY VALID_FROM) as prev_salary,
        LAG(EMPLOYMENT_TYPE) OVER (PARTITION BY EMAIL ORDER BY VALID_FROM) as prev_emp_type
    FROM MART.HIBOB.WORK_HISTORY
),
Change_Events AS (
    SELECT 
        EMAIL, VALID_FROM,
        CASE WHEN JOB_TITLE != prev_job OR prev_job IS NULL THEN VALID_FROM END as job_change_date,
        CASE WHEN SALARY_PAY_TYPE != prev_salary OR prev_salary IS NULL THEN VALID_FROM END as salary_change_date,
        CASE WHEN EMPLOYMENT_TYPE != prev_emp_type OR prev_emp_type IS NULL THEN VALID_FROM END as emp_type_change_date
    FROM History_Sorted
),
Latest_Changes AS (
    SELECT 
        EMAIL,
        MAX(job_change_date)::DATE as hb_LATEST_JOB_CHANGE_DATE,
        MAX(salary_change_date)::DATE as hb_LATEST_SALARY_CHANGE_DATE,
        MAX(emp_type_change_date)::DATE as hb_LATEST_EMP_TYPE_CHANGE_DATE
    FROM Change_Events
    GROUP BY EMAIL
),
History_Pivoted AS (
    SELECT 
        EMAIL,
        MAX(CASE WHEN rnk = 1 THEN JOB_TITLE END) AS CURRENT_JOB_TITLE,
        MAX(CASE WHEN rnk = 2 THEN JOB_TITLE END) AS PREVIOUS_JOB_TITLE,
        MAX(CASE WHEN rnk = 1 THEN SALARY_PAY_TYPE END) AS CURRENT_SALARY_PAY_TYPE,
        MAX(CASE WHEN rnk = 2 THEN SALARY_PAY_TYPE END) AS PREVIOUS_SALARY_PAY_TYPE,
        MAX(CASE WHEN rnk = 1 THEN EMPLOYMENT_TYPE END) AS CURRENT_EMPLOYMENT_TYPE,
        MAX(CASE WHEN rnk = 2 THEN EMPLOYMENT_TYPE END) AS PREVIOUS_EMPLOYMENT_TYPE
    FROM (
        SELECT EMAIL, JOB_TITLE, SALARY_PAY_TYPE, EMPLOYMENT_TYPE,
               ROW_NUMBER() OVER (PARTITION BY EMAIL ORDER BY VALID_FROM DESC) as rnk
        FROM MART.HIBOB.WORK_HISTORY
        QUALIFY rnk <= 2
    )
    GROUP BY EMAIL
)
SELECT 
    w.WF_ID,
    w.EMAIL_ADDRESS AS EMAIL,
    h.COUNTRY AS hb_COUNTRY,
    
    -- City / Site
    w.CITY AS wf_CITY, h.SITE AS hb_SITE,
    CASE WHEN NOT EQUAL_NULL(LOWER(TRIM(w.CITY)), LOWER(TRIM(h.SITE))) THEN TRUE ELSE NULL END AS FLAG_CITY_SITE,

    -- Name
    w.EMPLOYEE_NAME AS wf_EMPLOYEE_NAME, h.DISPLAY_NAME AS hb_DISPLAY_NAME,
    CASE WHEN NOT EQUAL_NULL(LOWER(TRIM(w.EMPLOYEE_NAME)), LOWER(TRIM(h.DISPLAY_NAME))) THEN TRUE ELSE NULL END AS FLAG_NAME,

    -- Teams Logic
    w.TEAM_NAME AS wf_TEAM_NAME,
    
    -- NEW: WF_TEAM_CHECK (Includes Poland Logic)
    CASE 
        WHEN h.COUNTRY = 'Poland' OR TO_VARCHAR(h.COUNTRY) = '264940782' THEN 'Central Warehouse'
        WHEN h.COST_CENTRE LIKE '%360%' THEN 'WH & Repairs'
        WHEN h.COST_CENTRE LIKE '%410%' THEN 'Field Ops'
        ELSE ''
    END AS WF_TEAM_CHECK,

    -- Updated TEAMS Logic (Includes Poland Logic)
    CASE 
        WHEN h.COUNTRY = 'Poland' OR TO_VARCHAR(h.COUNTRY) = '264940782' THEN 'Central Warehouse,Spare Parts Refurbishment,Vehicle Refurbishment'
        WHEN h.COST_CENTRE LIKE '%410%' THEN 'Field Ops,WH & Repairs,Inventory Work'
        WHEN h.COST_CENTRE LIKE '%360%' THEN 'WH & Repairs,Inventory Work,Field Ops'
        ELSE ''
    END AS Teams,

    -- Cost Center + Flag
    w.TEAM_COST_CENTER AS wf_TEAM_COST_CENTER, h.COST_CENTRE AS hb_COST_CENTRE,
    CASE WHEN NOT EQUAL_NULL(
            REGEXP_REPLACE(TO_VARCHAR(w.TEAM_COST_CENTER), '[^0-9]', ''), 
            REGEXP_REPLACE(TO_VARCHAR(h.COST_CENTRE), '[^0-9]', '')
         ) 
         THEN REGEXP_REPLACE(TO_VARCHAR(h.COST_CENTRE), '[^0-9]', '') 
         ELSE NULL END AS FLAG_COST_CENTER,

    -- Hours + Flag
    w.PREFERRED_HOURS AS wf_PREFERRED_HOURS, h.WEEKLY_HOURS AS hb_WEEKLY_HOURS,
    CASE 
        WHEN ABS(COALESCE(TRY_TO_DOUBLE(w.PREFERRED_HOURS), 0) - COALESCE(TRY_TO_DOUBLE(h.WEEKLY_HOURS), 0)) > 0.15 
        THEN h.WEEKLY_HOURS 
        ELSE NULL 
    END AS FLAG_HOURS,

    -- End Date + Status
    w.EMPLOYMENT_END_DATE AS wf_EMPLOYMENT_END_DATE, h.TERMINATION_DATE AS hb_TERMINATION_DATE,
    CASE 
        WHEN EQUAL_NULL(TRY_TO_DATE(w.EMPLOYMENT_END_DATE), TRY_TO_DATE(h.TERMINATION_DATE)) THEN NULL
        WHEN w.EMPLOYMENT_END_DATE IS NULL 
             AND TRY_TO_DATE(h.TERMINATION_DATE) >= DATE_TRUNC('MONTH', CURRENT_DATE()) 
             AND TRY_TO_DATE(h.TERMINATION_DATE) < DATEADD('MONTH', 1, DATE_TRUNC('MONTH', CURRENT_DATE())) 
             THEN 'Potential Extension'
        ELSE TO_VARCHAR(TRY_TO_DATE(h.TERMINATION_DATE), 'YYYY-MM-DD')
    END AS TERM_DATE_STATUS,

    w.EMPLOYMENT_START_DATE AS wf_EMPLOYMENT_START_DATE, h.START_DATE AS hb_START_DATE,

    w.IS_ACTIVE AS wf_IS_ACTIVE, w.AWARD_TAG_NAME AS wf_AWARD_TAG_NAME, h.IS_MANAGER AS hb_IS_MANAGER,

    -- Permissions (Based on Current Job Title)
    CASE 
        WHEN ph.CURRENT_JOB_TITLE ILIKE '%fleet manager%' OR ph.CURRENT_JOB_TITLE ILIKE '%head of fleet%' THEN 'TL/SM/FM'
        WHEN ph.CURRENT_JOB_TITLE ILIKE '%team lead%' 
             OR ph.CURRENT_JOB_TITLE ILIKE '%site manager%' 
             OR ph.CURRENT_JOB_TITLE ILIKE '%shift supervisor%' THEN 'TL/SM/FM,Employee'
        ELSE 'Employee'
    END AS Permissions,

    -- Assignment Action (Based on same logic as Permissions)
    CASE 
        WHEN ph.CURRENT_JOB_TITLE ILIKE '%fleet manager%' 
             OR ph.CURRENT_JOB_TITLE ILIKE '%head of fleet%' 
             OR ph.CURRENT_JOB_TITLE ILIKE '%team lead%' 
             OR ph.CURRENT_JOB_TITLE ILIKE '%site manager%' 
             OR ph.CURRENT_JOB_TITLE ILIKE '%shift supervisor%' 
        THEN 'assign to teams in WF'
        ELSE ''
    END AS TEAM_ASSIGNMENT_FLAG,

    -- History
    ph.CURRENT_JOB_TITLE AS hb_CURRENT_JOB_TITLE, ph.PREVIOUS_JOB_TITLE AS hb_PREVIOUS_JOB_TITLE,
    lc.hb_LATEST_JOB_CHANGE_DATE,
    CASE WHEN DATE_TRUNC('MONTH', lc.hb_LATEST_JOB_CHANGE_DATE) = DATE_TRUNC('MONTH', CURRENT_DATE()) THEN TRUE ELSE FALSE END AS FLAG_JOB_CHANGED_THIS_MONTH,

    ph.CURRENT_SALARY_PAY_TYPE AS hb_CURRENT_SALARY_PAY_TYPE, ph.PREVIOUS_SALARY_PAY_TYPE AS hb_PREVIOUS_SALARY_PAY_TYPE,
    lc.hb_LATEST_SALARY_CHANGE_DATE,
    CASE WHEN DATE_TRUNC('MONTH', lc.hb_LATEST_SALARY_CHANGE_DATE) = DATE_TRUNC('MONTH', CURRENT_DATE()) THEN TRUE ELSE FALSE END AS FLAG_SALARY_CHANGED_THIS_MONTH,

    ph.CURRENT_EMPLOYMENT_TYPE AS hb_CURRENT_EMPLOYMENT_TYPE, ph.PREVIOUS_EMPLOYMENT_TYPE AS hb_PREVIOUS_EMPLOYMENT_TYPE,
    lc.hb_LATEST_EMP_TYPE_CHANGE_DATE,
    CASE WHEN DATE_TRUNC('MONTH', lc.hb_LATEST_EMP_TYPE_CHANGE_DATE) = DATE_TRUNC('MONTH', CURRENT_DATE()) THEN TRUE ELSE FALSE END AS FLAG_EMP_TYPE_CHANGED_THIS_MONTH

FROM MART.WORKFORCE.EMPLOYEE w
JOIN MODEL_CONFIDENTIAL.HIBOB.HIBOB h ON w.EMAIL_ADDRESS = h.EMAIL
LEFT JOIN History_Pivoted ph ON w.EMAIL_ADDRESS = ph.EMAIL
LEFT JOIN Latest_Changes lc ON w.EMAIL_ADDRESS = lc.EMAIL

WHERE NOT (w.IS_ACTIVE = FALSE AND TRY_TO_DATE(h.TERMINATION_DATE) < CURRENT_DATE());
