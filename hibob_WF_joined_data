WITH History_Ranked AS (
    SELECT 
        EMAIL,
        JOB_TITLE,
        SALARY_PAY_TYPE,
        EMPLOYMENT_TYPE,
        ROW_NUMBER() OVER (PARTITION BY EMAIL ORDER BY VALID_FROM DESC) as rnk
    FROM MART.HIBOB.WORK_HISTORY
    QUALIFY rnk <= 2
),
History_Pivoted AS (
    SELECT 
        EMAIL,
        MAX(CASE WHEN rnk = 1 THEN JOB_TITLE END) AS CURRENT_JOB_TITLE,
        MAX(CASE WHEN rnk = 1 THEN SALARY_PAY_TYPE END) AS CURRENT_SALARY_PAY_TYPE,
        MAX(CASE WHEN rnk = 1 THEN EMPLOYMENT_TYPE END) AS CURRENT_EMPLOYMENT_TYPE,
        MAX(CASE WHEN rnk = 2 THEN JOB_TITLE END) AS PREVIOUS_JOB_TITLE,
        MAX(CASE WHEN rnk = 2 THEN SALARY_PAY_TYPE END) AS PREVIOUS_SALARY_PAY_TYPE,
        MAX(CASE WHEN rnk = 2 THEN EMPLOYMENT_TYPE END) AS PREVIOUS_EMPLOYMENT_TYPE
    FROM History_Ranked
    GROUP BY EMAIL
)
SELECT 
    w.EMAIL_ADDRESS AS EMAIL,
    
    -- Side-by-Side Pairs
    w.CITY AS wf_CITY,
    h.SITE AS hb_SITE,

    w.EMPLOYEE_NAME AS wf_EMPLOYEE_NAME,
    h.DISPLAY_NAME AS hb_DISPLAY_NAME,

    w.TEAM_NAME AS wf_TEAM_NAME,
    h.JOB_TITLE AS hb_JOB_TITLE,

    w.TEAM_COST_CENTER AS wf_TEAM_COST_CENTER,
    h.COST_CENTRE AS hb_COST_CENTRE,

    w.PREFERRED_HOURS AS wf_PREFERRED_HOURS,
    h.WEEKLY_HOURS AS hb_WEEKLY_HOURS,

    w.EMPLOYMENT_END_DATE AS wf_EMPLOYMENT_END_DATE,
    h.TERMINATION_DATE AS hb_TERMINATION_DATE,

    -- Unmatched Columns
    w.IS_ACTIVE AS wf_IS_ACTIVE,
    w.AWARD_TAG_NAME AS wf_AWARD_TAG_NAME,
    h.IS_MANAGER AS hb_IS_MANAGER,

    -- History Columns (at the end)
    ph.CURRENT_JOB_TITLE AS hb_CURRENT_JOB_TITLE,
    ph.PREVIOUS_JOB_TITLE AS hb_PREVIOUS_JOB_TITLE,
    ph.CURRENT_SALARY_PAY_TYPE AS hb_CURRENT_SALARY_PAY_TYPE,
    ph.PREVIOUS_SALARY_PAY_TYPE AS hb_PREVIOUS_SALARY_PAY_TYPE,
    ph.CURRENT_EMPLOYMENT_TYPE AS hb_CURRENT_EMPLOYMENT_TYPE,
    ph.PREVIOUS_EMPLOYMENT_TYPE AS hb_PREVIOUS_EMPLOYMENT_TYPE

FROM MART.WORKFORCE.EMPLOYEE w
JOIN MODEL_CONFIDENTIAL.HIBOB.HIBOB h 
    ON w.EMAIL_ADDRESS = h.EMAIL
LEFT JOIN History_Pivoted ph 
    ON w.EMAIL_ADDRESS = ph.EMAIL;
